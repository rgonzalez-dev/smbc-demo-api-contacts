trigger:
  - main
  - develop

pool:
  vmImage: 'ubuntu-latest'

variables:
  dockerRegistryServiceConnection: 'AzureContainerRegistry'
  imageRepository: 'contacts-api'
  containerRegistry: '$(AZURE_CONTAINER_REGISTRY)'
  dockerfilePath: '$(Build.SourcesDirectory)/Dockerfile'
  tag: '$(Build.BuildId)'
  imageName: '$(containerRegistry)/$(imageRepository):$(tag)'

stages:
  - stage: Build
    displayName: Build and Push Docker Image
    jobs:
      - job: BuildAndPush
        displayName: Build and Push
        steps:
          - task: Maven@3
            inputs:
              mavenPomFile: 'pom.xml'
              mavenOptions: '-Xmx3072m'
              javaHomeOption: 'JDKVersion'
              jdkVersionOption: '17'
              jdkArchitectureOption: 'x64'
              publishJUnitResults: true
              testResultsFiles: '**/surefire-reports/TEST-*.xml'
              goals: 'clean package'
            displayName: 'Maven Build'

          - script: |
              echo "$(AZURE_REGISTRY_PASSWORD)" | docker login -u $(AZURE_REGISTRY_USERNAME) --password-stdin $(containerRegistry)
            displayName: 'Login to ACR'

          - script: |
              docker build -t $(imageName) -f $(dockerfilePath) .
              docker tag $(imageName) $(containerRegistry)/$(imageRepository):latest
              docker push $(imageName)
              docker push $(containerRegistry)/$(imageRepository):latest
            displayName: 'Build and Push Docker Image'
            env:
              DOCKER_BUILDKIT: 1

  - stage: DeployAKS
    displayName: Deploy to AKS
    dependsOn: Build
    condition: succeeded()
    jobs:
      - job: DeployToAKS
        displayName: Deploy to AKS Cluster
        steps:
          - task: KubernetesManifest@0
            displayName: Deploy to Kubernetes
            inputs:
              action: 'deploy'
              kubernetesServiceConnection: 'AKS-Connection'
              namespace: 'default'
              manifests: |
                $(Pipeline.Workspace)/manifests/contacts-api-deployment.yaml
                $(Pipeline.Workspace)/manifests/contacts-api-service.yaml
              containers: |
                $(imageName)

  - stage: RegisterAPIM
    displayName: Register API in APIM
    dependsOn: DeployAKS
    condition: succeeded()
    jobs:
      - job: RegisterAPIM
        displayName: Register/Update APIM
        steps:
          - task: AzureCLI@2
            displayName: Register API in APIM
            inputs:
              azureSubscription: 'AzureServiceConnection'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                # Variables
                RESOURCE_GROUP="your-resource-group"
                APIM_NAME="your-apim-instance"
                API_NAME="contacts-api"
                BACKEND_URL="http://contacts-api.default.svc.cluster.local:8080"
                
                # Check if API exists
                if az apim api show --resource-group $RESOURCE_GROUP --service-name $APIM_NAME --api-id $API_NAME &>/dev/null; then
                  echo "API exists, updating backend URL..."
                  az apim api update --resource-group $RESOURCE_GROUP --service-name $APIM_NAME --api-id $API_NAME --service-url $BACKEND_URL
                else
                  echo "Creating new API in APIM..."
                  az apim api create --resource-group $RESOURCE_GROUP --service-name $APIM_NAME --api-id $API_NAME \
                    --display-name "Contacts API" --service-url $BACKEND_URL --protocols http https \
                    --path "/api/contacts" --api-type http
                fi
                
                echo "APIM registration complete for $API_NAME"
