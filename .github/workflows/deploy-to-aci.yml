name: Deploy to Azure Container Instances

on:
  push:
    branches:
      - main
      - develop
  workflow_dispatch:  # Allow manual triggering

env:
  REGISTRY: rgonzalez.azurecr.io
  IMAGE_NAME: contacts-api
  CONTAINER_NAME: contacts-api-container
  RESOURCE_GROUP: rgonzalez-env-a
  ACI_NAME: contacts-api-aci

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      image-tag: ${{ steps.image.outputs.tag }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set image tag
        id: image
        run: |
          TAG="${{ github.sha }}"
          echo "tag=${TAG:0:7}" >> $GITHUB_OUTPUT
          echo "full-tag=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${TAG:0:7}" >> $GITHUB_OUTPUT

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Login to ACR
        run: |
          az acr login --name rgonzalez

      - name: Build and push Docker image
        run: |
          docker build -t ${{ steps.image.outputs.full-tag }} -f Dockerfile .
          docker tag ${{ steps.image.outputs.full-tag }} ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
          docker push ${{ steps.image.outputs.full-tag }}
          docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
        env:
          DOCKER_BUILDKIT: 1

  deploy-to-aci:
    needs: build-and-push
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy to Azure Container Instances
        run: |
          az container create \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --name ${{ env.ACI_NAME }} \
            --image ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest \
            --registry-login-server ${{ env.REGISTRY }} \
            --registry-username ${{ secrets.AZURE_REGISTRY_USERNAME }} \
            --registry-password ${{ secrets.AZURE_REGISTRY_PASSWORD }} \
            --cpu 1 \
            --memory 1 \
            --ports 8080 \
            --protocol TCP \
            --dns-name-label contacts-api \
            --environment-variables \
              SPRING_PROFILES_ACTIVE=production \
              SPRING_DATASOURCE_DRIVER_CLASS_NAME=org.postgresql.Driver \
            --restart-policy OnFailure \
            --no-wait
        continue-on-error: true

      - name: Get ACI details
        run: |
          echo "Waiting for ACI to start..."
          sleep 10
          
          ACI_STATUS=$(az container show \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --name ${{ env.ACI_NAME }} \
            --query instanceView.state -o tsv)
          
          echo "Container State: $ACI_STATUS"
          
          FQDN=$(az container show \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --name ${{ env.ACI_NAME }} \
            --query ipAddress.fqdn -o tsv)
          
          echo "Container FQDN: $FQDN"
          echo "Access the application at: http://$FQDN:8080"

  verify-deployment:
    needs: deploy-to-aci
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Verify deployment
        run: |
          echo "Checking container status..."
          
          # Get container state
          STATE=$(az container show \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --name ${{ env.ACI_NAME }} \
            --query instanceView.state -o tsv)
          
          echo "Container State: $STATE"
          
          # Get FQDN
          FQDN=$(az container show \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --name ${{ env.ACI_NAME }} \
            --query ipAddress.fqdn -o tsv)
          
          if [ -n "$FQDN" ]; then
            echo "Container is accessible at: http://$FQDN:8080"
            echo "Health check endpoint: http://$FQDN:8080/actuator/health"
            
            # Try health check (allow some time for startup)
            sleep 30
            HEALTH=$(curl -s -o /dev/null -w "%{http_code}" http://$FQDN:8080/actuator/health || echo "timeout")
            
            if [ "$HEALTH" = "200" ]; then
              echo "✓ Health check passed!"
            else
              echo "⚠ Health check returned: $HEALTH"
              echo "Application may still be starting up..."
            fi
          else
            echo "⚠ Could not retrieve FQDN"
          fi
          
          # Show recent logs
          echo ""
          echo "Recent container logs:"
          az container logs \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --name ${{ env.ACI_NAME }} \
            --tail 20
