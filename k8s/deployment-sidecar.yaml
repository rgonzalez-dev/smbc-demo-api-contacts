apiVersion: v1
kind: Namespace
metadata:
  name: contacts-api

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: contacts-app-config
  namespace: contacts-api
data:
  application-local.properties: |
    spring.application.name=contacts-api
    server.address=0.0.0.0
    server.port=8080
    spring.datasource.url=jdbc:postgresql://localhost:5432/smbc_data
    spring.datasource.username=postgres
    spring.datasource.password=admin
    spring.datasource.driver-class-name=org.postgresql.Driver
    spring.datasource.hikari.maximum-pool-size=5
    spring.datasource.hikari.minimum-idle=2
    spring.datasource.hikari.connection-timeout=20000
    spring.datasource.hikari.idle-timeout=300000
    spring.datasource.hikari.max-lifetime=1200000
    spring.datasource.secondary.url=jdbc:postgresql://localhost:5432/smbc_data
    spring.datasource.secondary.username=postgres
    spring.datasource.secondary.password=admin
    spring.datasource.secondary.driver-class-name=org.postgresql.Driver
    spring.datasource.secondary.hikari.maximum-pool-size=3
    spring.datasource.secondary.hikari.minimum-idle=1
    spring.datasource.secondary.hikari.connection-timeout=20000
    spring.datasource.secondary.hikari.idle-timeout=300000
    spring.datasource.secondary.hikari.max-lifetime=1200000
    spring.jpa.database-platform=org.hibernate.dialect.PostgreSQLDialect
    spring.jpa.hibernate.ddl-auto=drop-and-create
    spring.jpa.show-sql=true
    spring.jpa.properties.hibernate.format_sql=true
    spring.kafka.bootstrap-servers=localhost:9092
    spring.kafka.producer.key-serializer=org.apache.kafka.common.serialization.StringSerializer
    spring.kafka.producer.value-serializer=org.springframework.kafka.support.serializer.JsonSerializer
    spring.kafka.producer.acks=all
    spring.kafka.producer.retries=3
    spring.kafka.producer.properties.linger.ms=10
    spring.kafka.producer.properties.batch.size=32768
    spring.kafka.consumer.bootstrap-servers=localhost:9092
    spring.kafka.consumer.group-id=contacts-service
    spring.kafka.consumer.key-deserializer=org.apache.kafka.common.serialization.StringDeserializer
    spring.kafka.consumer.value-deserializer=org.springframework.kafka.support.serializer.JsonDeserializer
    spring.kafka.consumer.properties.spring.json.trusted.packages=*
    spring.kafka.properties.connections.max.idle.ms=540000
    spring.kafka.properties.request.timeout.ms=30000
    spring.kafka.admin.properties.bootstrap.servers=localhost:9092
    kafka.auto-create-topics=false
    logging.level.root=INFO
    logging.level.rgonzalez.smbc=DEBUG

---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: postgres-data-pvc
  namespace: contacts-api
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 10Gi

---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: kafka-data-pvc
  namespace: contacts-api
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 20Gi

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: contacts-api
  namespace: contacts-api
  labels:
    app: contacts-api
    version: v1
spec:
  replicas: 1
  selector:
    matchLabels:
      app: contacts-api
  strategy:
    type: Recreate
  template:
    metadata:
      labels:
        app: contacts-api
        version: v1
    spec:
      serviceAccountName: default
      restartPolicy: Always
      initContainers:
        # Wait for PostgreSQL to be ready
        - name: wait-for-postgres
          image: busybox:1.35
          command: ['sh', '-c', 'until nc -z localhost 5432; do echo waiting for postgres; sleep 2; done']
          resources:
            requests:
              cpu: 100m
              memory: 64Mi
            limits:
              cpu: 200m
              memory: 128Mi
        # Wait for Kafka to be ready
        - name: wait-for-kafka
          image: busybox:1.35
          command: ['sh', '-c', 'until nc -z localhost 9092; do echo waiting for kafka; sleep 2; done']
          resources:
            requests:
              cpu: 100m
              memory: 64Mi
            limits:
              cpu: 200m
              memory: 128Mi

      containers:
        # PostgreSQL Sidecar Container
        - name: postgres
          image: postgres:15-alpine
          ports:
            - name: postgres
              containerPort: 5432
              protocol: TCP
          env:
            - name: POSTGRES_DB
              value: "smbc_data"
            - name: POSTGRES_USER
              value: "postgres"
            - name: POSTGRES_PASSWORD
              value: "admin"
            - name: PGDATA
              value: "/var/lib/postgresql/data/pgdata"
          volumeMounts:
            - name: postgres-data
              mountPath: /var/lib/postgresql/data
          livenessProbe:
            exec:
              command:
                - /bin/sh
                - -c
                - pg_isready -U postgres
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3
          readinessProbe:
            exec:
              command:
                - /bin/sh
                - -c
                - pg_isready -U postgres
            initialDelaySeconds: 10
            periodSeconds: 5
            timeoutSeconds: 3
            failureThreshold: 3
          resources:
            requests:
              cpu: 250m
              memory: 512Mi
            limits:
              cpu: 500m
              memory: 1Gi

        # Kafka Sidecar Container
        - name: kafka
          image: apache/kafka:latest
          ports:
            - name: kafka-broker
              containerPort: 9092
              protocol: TCP
            - name: kafka-controller
              containerPort: 9093
              protocol: TCP
          env:
            - name: KAFKA_PROCESS_ROLES
              value: "broker,controller"
            - name: KAFKA_CONTROLLER_LISTENER_NAMES
              value: "CONTROLLER"
            - name: KAFKA_CONTROLLER_QUORUM_VOTERS
              value: "1@localhost:9093"
            - name: KAFKA_LISTENERS
              value: "PLAINTEXT://:9092,CONTROLLER://:9093"
            - name: KAFKA_LISTENER_SECURITY_PROTOCOL_MAP
              value: "CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT"
            - name: KAFKA_ADVERTISED_LISTENERS
              value: "PLAINTEXT://localhost:9092"
            - name: KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR
              value: "1"
            - name: KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR
              value: "1"
            - name: KAFKA_TRANSACTION_STATE_LOG_MIN_ISR
              value: "1"
            - name: KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS
              value: "0"
            - name: KAFKA_NUM_PARTITIONS
              value: "3"
            - name: KAFKA_NODE_ID
              value: "1"
          volumeMounts:
            - name: kafka-data
              mountPath: /var/lib/kafka/data
          livenessProbe:
            exec:
              command:
                - /bin/sh
                - -c
                - nc -z localhost 9092
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3
          readinessProbe:
            exec:
              command:
                - /bin/sh
                - -c
                - nc -z localhost 9092
            initialDelaySeconds: 15
            periodSeconds: 5
            timeoutSeconds: 3
            failureThreshold: 3
          resources:
            requests:
              cpu: 500m
              memory: 1Gi
            limits:
              cpu: 1000m
              memory: 2Gi

        # Contacts API Main Container
        - name: contacts-api
          image: contacts-api:latest
          imagePullPolicy: Always
          ports:
            - name: http
              containerPort: 8080
              protocol: TCP
          env:
            - name: SPRING_PROFILES_ACTIVE
              value: "local"
            - name: SPRING_DATASOURCE_URL
              value: "jdbc:postgresql://localhost:5432/smbc_data"
            - name: SPRING_DATASOURCE_USERNAME
              value: "postgres"
            - name: SPRING_DATASOURCE_PASSWORD
              value: "admin"
            - name: SPRING_DATASOURCE_DRIVER_CLASS_NAME
              value: "org.postgresql.Driver"
            - name: SPRING_DATASOURCE_SECONDARY_URL
              value: "jdbc:postgresql://localhost:5432/smbc_data"
            - name: SPRING_DATASOURCE_SECONDARY_USERNAME
              value: "postgres"
            - name: SPRING_DATASOURCE_SECONDARY_PASSWORD
              value: "admin"
            - name: SPRING_KAFKA_BOOTSTRAP_SERVERS
              value: "localhost:9092"
            - name: SPRING_KAFKA_PRODUCER_KEY_SERIALIZER
              value: "org.apache.kafka.common.serialization.StringSerializer"
            - name: SPRING_KAFKA_PRODUCER_VALUE_SERIALIZER
              value: "org.springframework.kafka.support.serializer.JsonSerializer"
            - name: SPRING_KAFKA_CONSUMER_GROUP_ID
              value: "contacts-service"
            - name: SPRING_KAFKA_CONSUMER_KEY_DESERIALIZER
              value: "org.apache.kafka.common.serialization.StringDeserializer"
            - name: SPRING_KAFKA_CONSUMER_VALUE_DESERIALIZER
              value: "org.springframework.kafka.support.serializer.JsonDeserializer"
            - name: SPRING_JPA_HIBERNATE_DDL_AUTO
              value: "drop-and-create"
            - name: SPRING_JPA_SHOW_SQL
              value: "true"
          volumeMounts:
            - name: app-config
              mountPath: /etc/config
              readOnly: true
          livenessProbe:
            httpGet:
              path: /actuator/health
              port: http
            initialDelaySeconds: 60
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3
          readinessProbe:
            httpGet:
              path: /actuator/health
              port: http
            initialDelaySeconds: 30
            periodSeconds: 5
            timeoutSeconds: 3
            failureThreshold: 3
          resources:
            requests:
              cpu: 500m
              memory: 512Mi
            limits:
              cpu: 1000m
              memory: 1Gi

      volumes:
        - name: postgres-data
          persistentVolumeClaim:
            claimName: postgres-data-pvc
        - name: kafka-data
          persistentVolumeClaim:
            claimName: kafka-data-pvc
        - name: app-config
          configMap:
            name: contacts-app-config

---
apiVersion: v1
kind: Service
metadata:
  name: contacts-api
  namespace: contacts-api
  labels:
    app: contacts-api
spec:
  type: LoadBalancer
  ports:
    - name: http
      port: 8080
      targetPort: 8080
      protocol: TCP
  selector:
    app: contacts-api

---
apiVersion: v1
kind: Service
metadata:
  name: contacts-api-internal
  namespace: contacts-api
  labels:
    app: contacts-api
spec:
  type: ClusterIP
  ports:
    - name: http
      port: 8080
      targetPort: 8080
      protocol: TCP
    - name: postgres
      port: 5432
      targetPort: 5432
      protocol: TCP
    - name: kafka
      port: 9092
      targetPort: 9092
      protocol: TCP
  selector:
    app: contacts-api
